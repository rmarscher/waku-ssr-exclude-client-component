import{r as e}from"./index-BVOCwoKb.js";import{R as Y,u as Q,a as Z,b as V,p as tt,S as v,g as et}from"./client-CwvIu2bL.js";const K="R";function M(t){if(!t.startsWith("/"))throw new Error("Path must start with `/`: "+t);if(t==="/")return K+"/_root";if(t.endsWith("/"))throw new Error("Path must not end with `/`: "+t);return K+t}const B="ROUTE",W="IS_STATIC",nt="HAS404",z="X-Waku-Router-Skip",rt=t=>{for(const r of["/","/index.html"])if(t.endsWith(r))return t.slice(0,-r.length)||"/";return t},m=t=>{const{pathname:r,searchParams:o,hash:c}=t;return{path:rt(r),query:o.toString(),hash:c}},ot=()=>{const t=document.querySelector('meta[name="httpstatus"]');return t&&"content"in t&&t.content==="404"?{path:"/404",query:"",hash:""}:m(new URL(window.location.href))},st=t=>t.button!==0||!!(t.metaKey||t.altKey||t.ctrlKey||t.shiftKey);let U;const D=t=>{if(U&&U[0]===t)return U[1];const r=new URLSearchParams({query:t});return U=[t,r],r},L=e.createContext(null);function Et(){const t=e.useContext(L);if(!t)throw new Error("Missing Router");const{route:r,changeRoute:o,prefetchRoute:c}=t,l=e.useCallback(async(u,p)=>{const d=new URL(u,window.location.href),y=d.pathname!==window.location.pathname;window.history.pushState({...window.history.state,waku_new_path:y},"",d),await o(m(d),{shouldScroll:p?.scroll??y})},[o]),f=e.useCallback(async(u,p)=>{const d=new URL(u,window.location.href),y=d.pathname!==window.location.pathname;window.history.replaceState(window.history.state,"",d),await o(m(d),{shouldScroll:p?.scroll??y})},[o]),S=e.useCallback(async()=>{const u=new URL(window.location.href);await o(m(u),{shouldScroll:!0})},[o]),I=e.useCallback(()=>{window.history.back()},[]),g=e.useCallback(()=>{window.history.forward()},[]),R=e.useCallback(u=>{const p=new URL(u,window.location.href);c(m(p))},[c]);return{...r,push:l,replace:f,reload:S,back:I,forward:g,prefetch:R,unstable_events:t.routeChangeEvents}}function ct(t){const r=e.useRef(null),o=e.useCallback(c=>{r.current=c;const l=typeof t=="function";let f;return l?f=t(c):t&&(t.current=c),()=>{r.current=null,l?f?f():t(null):t&&(t.current=null)}},[t]);return[r,o]}function Rt({to:t,children:r,scroll:o,unstable_pending:c,unstable_notPending:l,unstable_prefetchOnEnter:f,unstable_prefetchOnView:S,unstable_startTransition:I,ref:g,...R}){const u=e.useContext(L),p=u?u.changeRoute:()=>{throw new Error("Missing Router")},d=u?u.prefetchRoute:()=>{throw new Error("Missing Router")},[y,P]=e.useTransition(),T=I||(c||l)&&P||(n=>n()),[_,C]=ct(g);e.useEffect(()=>{if(S&&_.current){const n=new IntersectionObserver(s=>{s.forEach(a=>{if(a.isIntersecting){const w=new URL(t,window.location.href);if(u&&w.href!==window.location.href){const i=m(w);u.prefetchRoute(i)}}})},{threshold:.1});return n.observe(_.current),()=>{n.disconnect()}}},[S,u,t,_]);const k=()=>{const n=new URL(t,window.location.href);if(n.href!==window.location.href){const s=m(n);d(s),T(async()=>{const a=n.pathname!==window.location.pathname;window.history.pushState({...window.history.state,waku_new_path:a},"",n),await p(s,{shouldScroll:o??a,unstable_startTransition:T})})}},A=n=>{R.onClick&&R.onClick(n),!n.defaultPrevented&&!st(n)&&(n.preventDefault(),k())},x=f?n=>{const s=new URL(t,window.location.href);if(s.href!==window.location.href){const a=m(s);d(a)}R.onMouseEnter?.(n)}:R.onMouseEnter,b=e.createElement("a",{...R,href:t,onClick:A,onMouseEnter:x,ref:C},r);return y&&c!==void 0?e.createElement(e.Fragment,null,b,c):!y&&l!==void 0?e.createElement(e.Fragment,null,b,l):b}const F=t=>()=>{throw new Error(`${t} is not in the server`)};function X(t){return e.createElement("html",null,e.createElement("body",null,e.createElement("h1",null,t)))}class pt extends e.Component{constructor(r){super(r),this.state={}}static getDerivedStateFromError(r){return{error:r}}render(){return"error"in this.state?this.state.error instanceof Error?X(this.state.error.message):X(String(this.state.error)):this.props.children}}const at=({has404:t,reset:r})=>{const o=e.useContext(L);if(!o)throw new Error("Missing Router");const{changeRoute:c}=o;return e.useEffect(()=>{if(t){const l=new URL("/404",window.location.href);c(m(l),{shouldScroll:!0}).then(()=>{setTimeout(()=>{r()},1)}).catch(f=>{console.log("Error while navigating to 404:",f)})}},[t,r,c]),t?null:e.createElement("h1",null,"Not Found")},it=({to:t,reset:r})=>{const o=e.useContext(L);if(!o)throw new Error("Missing Router");const{changeRoute:c}=o;return e.useEffect(()=>{const l=new URL(t,window.location.href);if(l.hostname!==window.location.hostname){window.location.replace(t);return}const f=l.pathname!==window.location.pathname;window.history.pushState({...window.history.state,waku_new_path:f},"",l),c(m(l),{shouldScroll:f}).then(()=>{setTimeout(()=>{r()},1)}).catch(S=>{console.log("Error while navigating to redirect:",S)})},[t,r,c]),null};class lt extends e.Component{constructor(r){super(r),this.state={error:null},this.reset=this.reset.bind(this)}static getDerivedStateFromError(r){return{error:r}}reset(){this.setState({error:null})}render(){const{error:r}=this.state;if(r!==null){const o=et(r);if(o?.status===404)return e.createElement(at,{has404:this.props.has404,reset:this.reset});if(o?.location)return e.createElement(it,{to:o.location,reset:this.reset});throw r}return this.props.children}}const ut=({error:t})=>{throw t},$=t=>"route:"+decodeURI(t),ht=()=>{const{hash:t}=window.location,{state:r}=window.history,o=t&&document.getElementById(t.slice(1));window.scrollTo({left:0,top:o?o.getBoundingClientRect().top+window.scrollY:0,behavior:r?.waku_new_path?"instant":"auto"})},wt=({initialRoute:t})=>{const r=Q(),[o,c]=e.useState(!1),l=e.useRef(new Set),f=e.useRef(new Set);e.useEffect(()=>{r.then(n=>{const{[B]:s,[W]:a,[nt]:w,...i}=n;if(w&&c(!0),s){const[h,E]=s;a&&l.current.add(h)}f.current=new Set(Object.keys(i))},()=>{})},[r]);const S=Z(),g=e.useRef(new Set).current;e.useEffect(()=>{const n=s=>(a,w={})=>{const i=JSON.stringify(Array.from(f.current)),h=w.headers||={};return Array.isArray(h)?h.push([z,i]):h[z]=i,s(a,w)};return S(s=>(a,w,i,h=fetch)=>{const E=n(h),N=s(a,w,i,E);return Promise.resolve(N).then((j={})=>{const{[B]:O,[W]:G}=j;if(O){const[q,H]=O;(window.location.pathname!==q||!G&&window.location.search.replace(/^\?/,"")!==H)&&g.forEach(J=>J(q,H))}}).catch(()=>{}),N})},[S,g]);const R=V(),[u,p]=e.useState(()=>({...t,hash:""})),d=e.useRef(null);if(d.current===null){const n={start:new Set,complete:new Set},s=(w,i)=>{const h=n[w];if(h.size)for(const E of h)E(i)},a={on:(h,E)=>{n[h].add(E)},off:(h,E)=>{n[h].delete(E)}};d.current=[a,s]}e.useEffect(()=>{p(n=>n.path===t.path&&n.query===t.query&&n.hash===t.hash?n:t)},[t]);const[y,P]=d.current,[T,_]=e.useState(null),C=e.useRef(null),k=e.useCallback(async(n,s)=>{P("start",n);const a=s.unstable_startTransition||(i=>i());C.current=[],_(null);const{skipRefetch:w}=s||{};if(!l.current.has(n.path)&&!w){const i=M(n.path),h=D(n.query);try{await R(i,h)}catch(E){throw C.current=null,_(E),E}}a(()=>{s.shouldScroll&&ht(),p(n),C.current[0]?.(),C.current=null,P("complete",n)})},[P,R]),A=e.useCallback(n=>{if(l.current.has(n.path))return;const s=M(n.path),a=D(n.query);tt(s,a),globalThis.__WAKU_ROUTER_PREFETCH__?.(n.path)},[]);e.useEffect(()=>{const n=()=>{const s=m(new URL(window.location.href));k(s,{shouldScroll:!0}).catch(a=>{console.log("Error while navigating back:",a)})};return window.addEventListener("popstate",n),()=>{window.removeEventListener("popstate",n)}},[k]),e.useEffect(()=>{const n=(s,a)=>{const w=()=>{const i=new URL(window.location.href);i.pathname=s,i.search=a,i.hash="",s!=="/404"&&window.history.pushState({...window.history.state,waku_new_path:i.pathname!==window.location.pathname},"",i),k(m(i),{skipRefetch:!0,shouldScroll:!1}).catch(h=>{console.log("Error while navigating to new route:",h)})};C.current?C.current.push(w):e.startTransition(w)};return g.add(n),()=>{g.delete(n)}},[k,g]);const x=T!==null?e.createElement(ut,{error:T}):e.createElement(v,{id:$(u.path)}),b=e.createElement(v,{id:"root"},e.createElement(lt,{has404:o},x));return e.createElement(L,{value:{route:u,changeRoute:k,prefetchRoute:A,routeChangeEvents:y}},b)};function St({initialRoute:t=ot()}){const r=M(t.path),o=D(t.query);return e.createElement(Y,{initialRscPath:r,initialRscParams:o},e.createElement(wt,{initialRoute:t}))}const ft={on:()=>F("routeChange:on"),off:()=>F("routeChange:off")};function gt({route:t,httpstatus:r}){const o=e.createElement(v,{id:$(t.path)}),c=e.createElement(v,{id:"root"},e.createElement("meta",{name:"httpstatus",content:`${r}`}),o);return e.createElement(e.Fragment,null,e.createElement(L,{value:{route:t,changeRoute:F("changeRoute"),prefetchRoute:F("prefetchRoute"),routeChangeEvents:ft}},c))}export{pt as ErrorBoundary,gt as INTERNAL_ServerRouter,Rt as Link,St as Router,Et as useRouter};
